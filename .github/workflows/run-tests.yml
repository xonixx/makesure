on: [ "push", "pull_request" ]

name: "Run tests"

jobs:
  nix:
    name: "Run tests *nix / all awks"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-18.04, ubuntu-20.04, ubuntu-22.04, macos-10.15, macos-11.0, macos-12 ]
    steps:
      - uses: actions/checkout@v2

      - uses: actions/cache@v2
        id: cache-soft
        with:
          path: soft
          key: ${{ matrix.os }}-soft--all-2

      - name: "run tests"
        run: |
          awk --version
          echo "aaa bbb" | awk '{ NF--; print $2 }'
          ./makesure_dev -f tests/12_errors_1.sh -l || true
          ./makesure tested_awks

  # https://github.com/marketplace/actions/freebsd-vm
  # https://github.com/vmactions/freebsd-vm
#  freebsd:
#    runs-on: macos-12
#    name: "Run tests on FreeBSD"
#    steps:
#      - uses: actions/checkout@v2
#      - name: Tests in FreeBSD
#        id: test
#        uses: vmactions/freebsd-vm@v0.3.0
#        with:
#          usesh: true
#          prepare: |
#            pkg install -y curl
#            # pkg install -y wget
#            pkg install -y bash
#            # pkg install -y gawk
#          run: |
#            echo "---------------------------------------"
#            freebsd-version
#            pwd
#            ls -l
#            bash --version  || true
#            awk --version   || true
#            gawk --version  || true
#            curl --version  || true
#            wget --version  || true
#            echo "======================================="
#            set -e
#            ./makesure
#
#  macos_gawk:
#    name: "Run tests macos / gawk"
#    runs-on: ${{ matrix.os }}
#    strategy:
#      matrix:
#        os: [ macos-10.15, macos-11.0, macos-12 ]
#    steps:
#      - uses: actions/checkout@v2
#
#      - uses: actions/cache@v2
#        id: cache-soft
#        with:
#          path: soft
#          key: ${{ matrix.os }}-soft--macos-gawk
#
#      - name: "run tests"
#        run: |
#          # TODO understand if this step can be cached
#          brew install gawk
#
#          PATH="/usr/local/opt/gawk/libexec/gnubin:$PATH" \
#            ./makesure
#
#  win:
#    name: "Run tests Win"
#    runs-on: ${{ matrix.os }}
#    strategy:
#      matrix:
#        os: [ windows-2019, windows-2022 ]
#    steps:
#      - uses: actions/checkout@v2
#
#      - uses: actions/cache@v2
#        id: cache-soft
#        with:
#          path: soft
#          key: ${{ matrix.os }}-soft--win
#
#      - name: "run tests"
#        run: |
#          & bash -e -c "./makesure"
